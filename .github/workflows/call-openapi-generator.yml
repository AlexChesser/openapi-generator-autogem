name: OpenAPI Generator

on:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: ${{ github.workspace }}
      - name: list files
        run: |
          pwd
          ls -al
      - name: Run OpenAPI Generator
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/local \
            openapitools/openapi-generator-cli:latest \
            java -jar /opt/openapi-generator/modules/openapi-generator-cli/target/openapi-generator-cli.jar \
            generate \
            -g ruby \
            -i https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/examples/v3.0/api-with-examples.json \
            -p packageName=my_client \
            -p gemVersion=1.0.0 \
            -p moduleName=MyClient \
            -p library=faraday \
            -o /local/my_client
      - name: list files
        run: |
          pwd
          ls -al
          sudo chown -R runner:docker .
          git add .
          ls -al
          git status
      - name: Detect changed files
        run: |
          CHANGED_FILES=$(git diff --name-only)
          echo $CHANGED_FILES
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected, exiting"
            exit 1
          fi
      - name: commit to main
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Update soure files"
          git push
      - name: Install Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0
      - name: build gemVersion
        run: |
          cd my_client
          ls -al
          sudo gem build my_client.gemspec
      # - name: commit to main
      #   run: |
      #     git config --global user.email "github-actions[bot]@users.noreply.github.com"
      #     git config --global user.name "github-actions[bot]"
      #     git add .
      #     git commit -m "Update gemVersion"
      #     git push
